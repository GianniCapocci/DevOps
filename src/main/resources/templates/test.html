<!DOCTYPE html>
<html lang="en">
<head>
    <title>Success</title>
    <link rel="stylesheet" href="/css/navbar.css">
</head>
<body>
<!-- Navigation Bar -->
<div class="navbar">
    <a href="/listings" class="app-name">MyAppName</a>
    <ul id="navbar">
        <!-- Navigation items will be inserted here -->
    </ul>
    <a href="/logout" class="logout" id="logoutLink">Logout</a>
</div>

<h1>Login Successful</h1>
<p>Welcome to the application! You have successfully logged in.</p>

<!-- Button that redirects to an internal URL -->
<a href="/test" class="button">Go to Test</a>
<a href="/listings" class="button">Go to Listings</a>
<a href="/listings/add" class="button">Go to Listings Add</a>
<a href="/admin" class="button">Go to Admin</a>
<a href="/admin/manage/users" class="button">Go to Admin Manage Users</a>
<a href="/admin/manage/listings" class="button">Go to Admin Manage Listings</a>
<a href="/broker/manage/listings" class="button">Go to Broker Manage Listings</a>
<a href="/admin/add/listing" class="button">Go to Admin Add Listing</a>
<a href="/broker/unassigned" class="button">Go to Broker Unassigned Listings</a>
<button id="fetchRolesButton" class="button">Fetch User Roles</button>

<script>
    // Function to fetch user roles
    function fetchUserRoles() {
        return fetch('/api/user/roles', {
            method: 'GET', // Use GET method
            headers: {
                'Content-Type': 'application/json',
                // Include any authentication headers or tokens if necessary
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .catch(error => {
                console.error('Error fetching user roles:', error);
                return []; // Return an empty array in case of error
            });
    }

    // Function to generate and display navigation bar based on roles
    function displayNavbar(roles) {
        const navbar = document.getElementById('navbar');

        // Define the options and the roles that can access them
        const options = [
            { text: 'Listings', url: '/listings', roles: ['ROLE_CLIENT', 'ROLE_BROKER', 'ROLE_ADMIN'] },
            { text: 'Add Listings', url: '/listings/add', roles: ['ROLE_BROKER'] },
            { text: 'Admin Page', url: '/admin', roles: ['ROLE_ADMIN'] },
            { text: 'Unassigned Listings', url: '/broker/unassigned', roles: ['ROLE_BROKER', 'ROLE_ADMIN'] }
        ];

        // Clear existing items
        navbar.innerHTML = '';

        // Generate the navigation items based on roles
        options.forEach(option => {
            if (roles.some(role => option.roles.includes(role))) {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = option.url;
                a.textContent = option.text;
                li.appendChild(a);
                navbar.appendChild(li);
            }
        });
    }

    // Initialize page by fetching roles and displaying navbar
    function initializePage() {
        fetchUserRoles()
            .then(roles => {
                displayNavbar(roles);
            })
            .catch(error => {
                console.error('Error initializing page:', error);
            });
    }

    // Run the initialization function when the page loads
    window.onload = initializePage;

    // Add event listener to the button
    document.getElementById('fetchRolesButton').addEventListener('click', fetchUserRoles);

    document.addEventListener('DOMContentLoaded', function() {
        var logoutLink = document.getElementById('logoutLink');

        logoutLink.addEventListener('click', function(event) {
            event.preventDefault(); // Prevent the default link behavior

            // Perform the logout operation
            fetch('/logout', {
                method: 'POST', // Use POST as configured in Spring Security
                credentials: 'same-origin', // Include cookies with the request
            })
                .then(response => {
                    if (response.ok) {
                        // Redirect to login page or homepage
                        window.location.href = '/login'; // Adjust as needed
                    } else {
                        // Handle logout failure (optional)
                        console.error('Logout failed');
                    }
                })
                .catch(error => {
                    console.error('Error during logout:', error);
                });
        });
    });
</script>
</body>
</html>
